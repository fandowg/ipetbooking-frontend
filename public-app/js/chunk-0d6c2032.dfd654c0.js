(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-0d6c2032"],{8891:function(t,e,i){"use strict";var n=i("893e"),a=i.n(n);e["default"]=a.a},"893e":function(t,e,i){t.exports={slide:"noti_slide_-5rb2","slide-reverse":"noti_slide-reverse_2myKI",action:"noti_action_2DzBE",chat:"noti_chat_2rfdK",empty:"noti_empty_2mFYt"}},"8e1a":function(t,e,i){"use strict";i.r(e);var n=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("span",{class:t.$style.action},[i("el-dropdown",{class:t.$style.action,attrs:{trigger:"click"}},[i("el-badge",{staticClass:"item",attrs:{hidden:0===t.unreadChatCount,value:t.unreadChatCount}},[i("BaseIcon",{attrs:{name:"bell"}})],1),i("el-dropdown-menu",{class:[t.$style["action-menu"],t.$style.chat],attrs:{slot:"dropdown"},slot:"dropdown"},[i("el-dropdown-item",{staticClass:"title",attrs:{divided:""}},[t._v("\n        新訊息\n      ")]),t.isEmptyList?[i("div",{class:t.$style.empty},[t._v("暫無資料")])]:t._l(t.notiList,function(e,n){return i("el-dropdown-item",{key:n,staticClass:"message",class:e.unreadCount>0?"unread":"",attrs:{command:"goChat",divided:""}},[i("div",{on:{click:function(i){return t.goChat(e)}}},[i("div",{staticClass:"name-date"},[i("div",{staticClass:"name"},[t._v(t._s(e.name)+" "+t._s(e.unreadCount>0?"（"+e.unreadCount+"）":""))]),i("div",{staticClass:"date"},[t._v(t._s(t._f("formatTimeOrDate")(e.created_at)))])]),i("div",{staticClass:"phone"},[t._v(t._s(e.phoneCode+" "+e.phoneNumber))]),i("div",{staticClass:"text"},[t._v(t._s(e.message||"客戶傳送了圖片。"))])])])}),i("el-dropdown-item",{staticClass:"view-all",attrs:{command:"goChatList",divided:""}},[i("div",{on:{click:t.goChatList}},[t._v("查看所有訊息")])])],2)],1)],1)},a=[],s=i("4795"),o=i.n(s),r=i("cb0c"),c=i("9395"),d=i("6bea"),h=i("4d77"),u=i("8055"),m=i.n(u),l=i("5638"),p={filters:{formatDate:d["a"],formatTimeOrDate:function(t){var e=new Date(t).getDate()===(new Date).getDate();return e?Object(d["a"])(t,"time"):Object(d["a"])(t)}},data:function(){return{notiList:[],displayLimit:5}},computed:Object(c["a"])({},h["b"],h["f"],{unreadChatCount:function(){var t=0;return this.notiList.forEach(function(e){e.unreadCount&&t++}),t},isEmptyList:function(){return 0===this.notiList.length},isHttps:function(){return"https:"===window.location.protocol},isAllowNoti:function(){return"granted"===window.Notification.permission}}),watch:{},created:function(){this.tryToSearch(),this.initBrowserNotification()},mounted:function(){this.isHttps&&this.initEcho()},beforeDestroy:function(){this.isHttps&&this.echo.leave("chat.".concat(this.currentUser.merchantId))},methods:{tryToSearch:function(){var t=Object(r["a"])(o.a.mark(function t(){var e,i,n;return o.a.wrap(function(t){while(1)switch(t.prev=t.next){case 0:return e={order:"desc",type:"chat",page:1,limit:5},t.next=3,this.$store.dispatch("member/fetchChats",e);case 3:i=t.sent,n=i.items,this.notiList=n;case 6:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}(),goChat:function(t){this.$router.push({name:"view-chat",params:{memberId:t.member_id}})},goChatList:function(){this.$router.push({name:"chat"})},initEcho:function(){var t=this,e="https:"===document.location.protocol?":8443":":6001";this.echo=new l["a"]({client:m.a,broadcaster:"socket.io",host:window.location.hostname+e,namespace:"DaydreamLab.Dddream.Events.Chat",auth:{headers:{Authorization:"Bearer "+this.currentUser.token}}}),this.echo.private("chat.".concat(this.currentUser.merchantId)).notification(function(e){t.updateList(e.data),t.showNoti(e.data)})},updateList:function(t){var e=this;if(!this.isSameWithActiveChatMember(t.member_id)){var i=this.notiList.some(function(i,n){return i.member_id===t.member_id&&(e.notiList.splice(n,1,Object(c["a"])({},t)),!0)});i||this.notiList.unshift(t),this.notiList.length>this.displayLimit&&this.notiList.pop(),this.sortListToDescByDateTime()}},sortListToDescByDateTime:function(){this.notiList.sort(function(t,e){return Date.parse(t.created_at)<Date.parse(e.created_at)?1:Date.parse(t.created_at)>Date.parse(e.created_at)?-1:0})},initBrowserNotification:function(){"Notification"in window?"denied"!==window.Notification.permission&&window.Notification.requestPermission():console.log("This browser does not support desktop notification")},showNoti:function(t){this.isAllowNoti&&!this.isSameWithActiveChatMember(t.member_id)&&new Notification(t.name,{body:t.message,icon:"/favicon.ico"})},isSameWithActiveChatMember:function(t){return this.activeChatMemberId===t}}},f=p,v=i("8891"),w=i("2877");function _(t){this["$style"]=v["default"].locals||v["default"]}var C=Object(w["a"])(f,n,a,!1,_,null,null);e["default"]=C.exports}}]);
//# sourceMappingURL=chunk-0d6c2032.dfd654c0.js.map